<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Kasir Online - Konfigurasi Final</title>
    <!-- Memuat Tailwind CSS untuk styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Memuat Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        #historyList::-webkit-scrollbar { width: 8px; }
        #historyList::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        #historyList::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        #historyList::-webkit-scrollbar-thumb:hover { background: #555; }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3b82f6;
            width: 40px;
            height: 40px;
            animation: spin 1.5s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Kontainer Utama Aplikasi -->
    <div class="w-full max-w-2xl bg-white rounded-2xl shadow-xl p-6 md:p-8 space-y-6">
        
        <header class="text-center">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Rekap Kasir Harian Online</h1>
            <p class="text-gray-500 mt-1">Total di bawah ini akan ter-reset setiap hari.</p>
        </header>

        <div id="main-content" class="hidden">
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center pt-4">
                <div class="bg-green-100 text-green-800 rounded-xl p-4 shadow"><h2 class="text-sm font-medium text-green-600">TOTAL SETORAN HARI INI</h2><p id="totalDepositToday" class="text-2xl md:text-3xl font-bold tracking-tight mt-1">Rp 0,00</p></div>
                <div class="bg-red-100 text-red-800 rounded-xl p-4 shadow"><h2 class="text-sm font-medium text-red-600">TOTAL TARIKAN HARI INI</h2><p id="totalWithdrawalToday" class="text-2xl md:text-3xl font-bold tracking-tight mt-1">Rp 0,00</p></div>
                <div class="bg-blue-100 text-blue-800 rounded-xl p-4 shadow"><h2 class="text-sm font-medium text-blue-600">TOTAL ADMIN HARI INI</h2><p id="totalAdminFeeToday" class="text-2xl md:text-3xl font-bold tracking-tight mt-1">Rp 0,00</p></div>
            </div>

            <form id="transactionForm" class="border-t border-gray-200 pt-6 space-y-4">
                <div id="sourceWrapper">
                    <label for="sourceSelect" class="block text-sm font-medium text-gray-700 mb-1">Sumber Transaksi</label>
                    <select id="sourceSelect" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 py-3 px-4 text-lg">
                        <option>Uang Tunai</option>
                        <option>BRI</option>
                        <option>BCA</option>
                        <option>Seabank</option>
                        <option>Dana</option>
                        <option>Gopay</option>
                        <option>Digipos</option>
                        <option>Order Quota</option>
                        <option>Simpel</option>
                    </select>
                </div>

                <div><label for="amount" class="block text-sm font-medium text-gray-700 mb-1">Jumlah Transaksi</label><div class="relative"><div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3"><span class="text-gray-500 sm:text-sm">Rp</span></div><input type="number" id="amount" class="block w-full rounded-md border-gray-300 pl-10 pr-4 py-3 text-lg focus:border-indigo-500 focus:ring-indigo-500" placeholder="0" required></div></div>
                <div><label for="description" class="block text-sm font-medium text-gray-700 mb-1">Keterangan (Wajib Diisi)</label><input type="text" id="description" class="block w-full rounded-md border-gray-300 px-4 py-3 text-lg focus:border-indigo-500 focus:ring-indigo-500" placeholder="Contoh: Tarik tunai Budi" required></div>
                <div><label class="block text-sm font-medium text-gray-700 mb-2">Gunakan Biaya Admin?</label><div id="adminFeeToggle" class="flex items-center space-x-4"><label class="flex items-center"><input type="radio" name="useAdminFee" value="tidak" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500" checked> <span class="ml-2 text-gray-700">Tidak</span></label><label class="flex items-center"><input type="radio" name="useAdminFee" value="iya" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500"> <span class="ml-2 text-gray-700">Iya</span></label></div></div>
                <div id="adminFeeWrapper" class="hidden"><label for="adminFee" class="block text-sm font-medium text-gray-700 mb-1">Jumlah Biaya Admin</label><div class="relative"><div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3"><span class="text-gray-500 sm:text-sm">Rp</span></div><input type="number" id="adminFee" class="block w-full rounded-md border-gray-300 pl-10 pr-4 py-3 text-lg focus:border-indigo-500 focus:ring-indigo-500" placeholder="0"></div></div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><button type="button" id="depositBtn" class="flex items-center justify-center w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105 shadow-md disabled:opacity-50 disabled:cursor-not-allowed">Setor Tunai</button><button type="button" id="withdrawBtn" class="flex items-center justify-center w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105 shadow-md disabled:opacity-50 disabled:cursor-not-allowed">Tarik Tunai</button></div>
            </form>
            <div id="errorMessage" class="hidden text-center text-red-600 font-medium p-2 rounded-lg bg-red-50"></div>
            <div class="border-t border-gray-200 pt-6"><h3 class="text-lg font-semibold text-gray-800 mb-4 text-center">Riwayat Semua Transaksi</h3><div id="historyList" class="max-h-64 overflow-y-auto space-y-3 pr-2"><p id="noHistory" class="text-center text-gray-500">Belum ada transaksi.</p></div></div>
        </div>
        <div id="loading" class="flex flex-col items-center justify-center p-8"><div class="loader"></div><p class="text-gray-500 mt-4">Menghubungkan ke database online...</p></div>
    </div>

    <!-- Modal Konfirmasi -->
    <div id="confirmationModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8 w-full max-w-md space-y-4">
            <h3 class="text-xl font-bold text-gray-800 text-center">Konfirmasi Transaksi</h3>
            <div class="border-t border-b border-gray-200 py-4 space-y-2">
                <div class="flex justify-between"><span class="text-gray-500">Tipe:</span><strong id="confirmType" class="font-semibold text-gray-900"></strong></div>
                <div class="flex justify-between"><span class="text-gray-500">Sumber:</span><strong id="confirmSource" class="font-semibold text-gray-900"></strong></div>
                <div class="flex justify-between"><span class="text-gray-500">Jumlah:</span><strong id="confirmAmount" class="font-semibold text-gray-900"></strong></div>
                <div class="flex justify-between"><span class="text-gray-500">Keterangan:</span><strong id="confirmDescription" class="font-semibold text-gray-900 text-right truncate"></strong></div>
                <div class="flex justify-between"><span class="text-gray-500">Biaya Admin:</span><strong id="confirmAdminFee" class="font-semibold text-gray-900"></strong></div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <button id="cancelBtnModal" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-4 rounded-lg">Batal</button>
                <button id="confirmBtnModal" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg">Konfirmasi & Simpan</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- KONFIGURASI FIREBASE ANDA TELAH DIMASUKKAN DI SINI ---
        const firebaseConfig = {
          apiKey: "AIzaSyApmezbFi-ntkp_J8T-b7uk2NTZeFuzBrI",
          authDomain: "kasir-coba-e8862.firebaseapp.com",
          projectId: "kasir-coba-e8862",
          storageBucket: "kasir-coba-e8862.appspot.com",
          messagingSenderId: "529514154178",
          appId: "1:529514154178:web:339fed8dac7e37c367135b",
          measurementId: "G-736R59S3P3"
        };


        // --- SELEKSI ELEMEN DOM ---
        const totalDepositTodayEl=document.getElementById("totalDepositToday"),totalWithdrawalTodayEl=document.getElementById("totalWithdrawalToday"),totalAdminFeeTodayEl=document.getElementById("totalAdminFeeToday"),amountInput=document.getElementById("amount"),descriptionInput=document.getElementById("description"),adminFeeInput=document.getElementById("adminFee"),sourceSelect=document.getElementById("sourceSelect"),depositBtn=document.getElementById("depositBtn"),withdrawBtn=document.getElementById("withdrawBtn"),historyListEl=document.getElementById("historyList"),errorMessageEl=document.getElementById("errorMessage"),loadingEl=document.getElementById("loading"),mainContentEl=document.getElementById("main-content"),transactionForm=document.getElementById("transactionForm"),adminFeeToggle=document.getElementById("adminFeeToggle"),adminFeeWrapper=document.getElementById("adminFeeWrapper"),sourceWrapper=document.getElementById("sourceWrapper");
        const confirmationModal=document.getElementById("confirmationModal"),confirmType=document.getElementById("confirmType"),confirmSource=document.getElementById("confirmSource"),confirmAmount=document.getElementById("confirmAmount"),confirmDescription=document.getElementById("confirmDescription"),confirmAdminFee=document.getElementById("confirmAdminFee"),cancelBtnModal=document.getElementById("cancelBtnModal"),confirmBtnModal=document.getElementById("confirmBtnModal");

        let db, transactionsCollection, pendingTransaction = null, currentTransactionType = 'setor';

        function formatCurrency(e){return new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(e)}
        function isToday(e){if(!e)return!1;const t=e.toDate(),n=new Date;return t.getDate()===n.getDate()&&t.getMonth()===n.getMonth()&&t.getFullYear()===n.getFullYear()}
        function showError(e){errorMessageEl.textContent=e,errorMessageEl.classList.remove("hidden"),setTimeout(()=>{errorMessageEl.classList.add("hidden")},4e3)}
        
        function updateUI(e){let t=0,n=0,o=0;e.forEach(e=>{isToday(e.createdAt)&&("setor"===e.type?t+=e.amount:n+=e.amount,o+=e.adminFee)}),totalDepositTodayEl.textContent=formatCurrency(t),totalWithdrawalTodayEl.textContent=formatCurrency(n),totalAdminFeeTodayEl.textContent=formatCurrency(o),historyListEl.innerHTML="",0===e.length?historyListEl.innerHTML='<p class="text-center text-gray-500">Belum ada transaksi.</p>':e.forEach(e=>{const t=e.createdAt.toDate(),n=e.source?`<p class="text-sm text-gray-500">Sumber: <strong>${e.source}</strong></p>`:"",o=`\n                        <div class="flex justify-between items-start bg-gray-50 p-3 rounded-lg">\n                            <div class="flex-grow">\n                                <p class="font-semibold capitalize">${e.type} Tunai</p>\n                                <p class="text-sm italic text-gray-600">${e.description||""}</p>\n                                ${n}\n                                <p class="text-xs text-gray-500 mt-1">${t.toLocaleString("id-ID",{dateStyle:"full",timeStyle:"short"})}</p>\n                            </div>\n                            <div class="text-right flex-shrink-0 ml-4">\n                                <p class="font-semibold ${"setor"===e.type?"text-green-600":"text-red-600"}">${"setor"===e.type?"+":"-"} ${formatCurrency(e.amount)}</p>\n                                ${e.adminFee>0?`<p class="text-xs text-gray-400">Biaya Admin: ${formatCurrency(e.adminFee)}</p>`:""}\n                            </div>\n                        </div>`;historyListEl.insertAdjacentHTML("beforeend",o)})}
        
        function showConfirmation(e){
            pendingTransaction = e;
            const t=e.type.charAt(0).toUpperCase()+e.type.slice(1);
            confirmType.textContent=`${t} Tunai`,
            confirmSource.textContent=e.source,
            confirmAmount.textContent=formatCurrency(e.amount),
            confirmDescription.textContent=e.description,
            confirmAdminFee.textContent=formatCurrency(e.adminFee),
            confirmationModal.classList.remove("hidden")
        }

        async function saveTransaction(){
            if (!pendingTransaction) return;
            depositBtn.disabled = true; withdrawBtn.disabled = true; confirmBtnModal.disabled = true;
            confirmBtnModal.textContent = "Menyimpan...";
            try {
                await addDoc(transactionsCollection, pendingTransaction);
                transactionForm.reset();
                adminFeeWrapper.classList.add('hidden');
                setTransactionMode('setor');
                amountInput.focus();
            } catch (error) {
                console.error("Error: ", error); showError("Gagal menyimpan. Cek koneksi.");
            } finally {
                confirmationModal.classList.add('hidden');
                depositBtn.disabled = false; withdrawBtn.disabled = false; confirmBtnModal.disabled = false;
                confirmBtnModal.textContent = "Konfirmasi & Simpan";
                pendingTransaction = null;
            }
        }
        
        function prepareTransaction(e){
            const t=parseFloat(amountInput.value),n=descriptionInput.value.trim(),o=document.querySelector('input[name="useAdminFee"]:checked').value,a=sourceSelect.value;
            let r=0;
            if(isNaN(t)||t<=0)return void showError("Jumlah transaksi harus valid.");
            if(!n)return void showError("Keterangan wajib diisi.");
            if("iya"===o){const e=parseFloat(adminFeeInput.value);if(isNaN(e)||e<=0)return void showError('Jika "Iya", biaya admin wajib diisi dan lebih dari nol.');r=e}
            const i={type:e,amount:t,description:n,adminFee:r,source:a,createdAt:serverTimestamp()};
            showConfirmation(i)
        }

        function setTransactionMode(type) {
            currentTransactionType = type;
            const sourceLabel = sourceWrapper.querySelector('label');
            if (type === 'setor') {
                sourceLabel.textContent = "Sumber Setoran";
            } else {
                sourceLabel.textContent = "Sumber Tarik Tunai";
            }
        }
        
        async function initialize(){
            if(!firebaseConfig.apiKey){
                loadingEl.innerHTML = '<p class="text-red-500 font-semibold text-center">KONFIGURASI FIREBASE KOSONG.</p>';
                return;
            }
            try{
                const app=initializeApp(firebaseConfig);
                const auth=getAuth(app);
                db=getFirestore(app);
                await signInAnonymously(auth);
                transactionsCollection = collection(db, "transactions");
                const q=query(transactionsCollection,orderBy("createdAt","desc"));
                onSnapshot(q,(snapshot)=>{
                    const transactions=snapshot.docs.map(doc=>({id:doc.id,...doc.data()}));
                    updateUI(transactions);
                    loadingEl.classList.add('hidden');
                    mainContentEl.classList.remove('hidden');
                }, (error) => {
                     console.error("Firebase Error:", error);
                     loadingEl.innerHTML = `<p class="text-red-500 font-semibold text-center">Error: ${error.message}. Coba refresh.</p>`;
                });
                
                depositBtn.addEventListener("click",()=>{ setTransactionMode('setor'); prepareTransaction("setor") });
                withdrawBtn.addEventListener("click",()=>{ setTransactionMode('tarik'); prepareTransaction("tarik") });
                transactionForm.addEventListener("submit",(e)=>{ e.preventDefault(); prepareTransaction(currentTransactionType); });
                adminFeeToggle.addEventListener("change",(e)=>{e.target.value==="iya"?adminFeeWrapper.classList.remove("hidden"):adminFeeWrapper.classList.add("hidden")});
                
                cancelBtnModal.addEventListener("click",()=>confirmationModal.classList.add("hidden"));
                confirmBtnModal.addEventListener("click",saveTransaction);

            } catch (error) {
                console.error("Init Gagal:", error);
                loadingEl.innerHTML = '<p class="text-red-500 font-semibold">Gagal terhubung. Periksa konfigurasi Firebase Anda.</p>';
            }
        }
        initialize();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Kasir Online - Konfigurasi Final</title>
    <!-- Memuat Tailwind CSS untuk styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Memuat Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        #historyList::-webkit-scrollbar { width: 8px; }
        #historyList::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        #historyList::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        #historyList::-webkit-scrollbar-thumb:hover { background: #555; }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3b82f6;
            width: 40px;
            height: 40px;
            animation: spin 1.5s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Kontainer Utama Aplikasi -->
    <div class="w-full max-w-2xl bg-white rounded-2xl shadow-xl p-6 md:p-8 space-y-6">
        
        <header class="text-center">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Rekap Kasir Harian Online</h1>
            <p class="text-gray-500 mt-1">Total di bawah ini akan ter-reset setiap hari.</p>
        </header>

        <div id="main-content" class="hidden">
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center pt-4">
                <div class="bg-green-100 text-green-800 rounded-xl p-4 shadow"><h2 class="text-sm font-medium text-green-600">TOTAL SETORAN HARI INI</h2><p id="totalDepositToday" class="text-2xl md:text-3xl font-bold tracking-tight mt-1">Rp 0,00</p></div>
                <div class="bg-red-100 text-red-800 rounded-xl p-4 shadow"><h2 class="text-sm font-medium text-red-600">TOTAL TARIKAN HARI INI</h2><p id="totalWithdrawalToday" class="text-2xl md:text-3xl font-bold tracking-tight mt-1">Rp 0,00</p></div>
                <div class="bg-blue-100 text-blue-800 rounded-xl p-4 shadow"><h2 class="text-sm font-medium text-blue-600">TOTAL ADMIN HARI INI</h2><p id="totalAdminFeeToday" class="text-2xl md:text-3xl font-bold tracking-tight mt-1">Rp 0,00</p></div>
            </div>

            <form id="transactionForm" class="border-t border-gray-200 pt-6 space-y-4">
                <div id="sourceWrapper">
                    <label for="sourceSelect" class="block text-sm font-medium text-gray-700 mb-1">Sumber Transaksi</label>
                    <select id="sourceSelect" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 py-3 px-4 text-lg">
                        <option>Uang Tunai</option>
                        <option>BRI</option>
                        <option>BCA</option>
                        <option>Seabank</option>
                        <option>Dana</option>
                        <option>Gopay</option>
                        <option>Digipos</option>
                        <option>Order Quota</option>
                        <option>Simpel</option>
                    </select>
                </div>

                <div><label for="amount" class="block text-sm font-medium text-gray-700 mb-1">Jumlah Transaksi</label><div class="relative"><div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3"><span class="text-gray-500 sm:text-sm">Rp</span></div><input type="number" id="amount" class="block w-full rounded-md border-gray-300 pl-10 pr-4 py-3 text-lg focus:border-indigo-500 focus:ring-indigo-500" placeholder="0" required></div></div>
                <div><label for="description" class="block text-sm font-medium text-gray-700 mb-1">Keterangan (Wajib Diisi)</label><input type="text" id="description" class="block w-full rounded-md border-gray-300 px-4 py-3 text-lg focus:border-indigo-500 focus:ring-indigo-500" placeholder="Contoh: Tarik tunai Budi" required></div>
                <div><label class="block text-sm font-medium text-gray-700 mb-2">Gunakan Biaya Admin?</label><div id="adminFeeToggle" class="flex items-center space-x-4"><label class="flex items-center"><input type="radio" name="useAdminFee" value="tidak" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500" checked> <span class="ml-2 text-gray-700">Tidak</span></label><label class="flex items-center"><input type="radio" name="useAdminFee" value="iya" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500"> <span class="ml-2 text-gray-700">Iya</span></label></div></div>
                <div id="adminFeeWrapper" class="hidden"><label for="adminFee" class="block text-sm font-medium text-gray-700 mb-1">Jumlah Biaya Admin</label><div class="relative"><div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3"><span class="text-gray-500 sm:text-sm">Rp</span></div><input type="number" id="adminFee" class="block w-full rounded-md border-gray-300 pl-10 pr-4 py-3 text-lg focus:border-indigo-500 focus:ring-indigo-500" placeholder="0"></div></div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><button type="button" id="depositBtn" class="flex items-center justify-center w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105 shadow-md disabled:opacity-50 disabled:cursor-not-allowed">Setor Tunai</button><button type="button" id="withdrawBtn" class="flex items-center justify-center w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105 shadow-md disabled:opacity-50 disabled:cursor-not-allowed">Tarik Tunai</button></div>
            </form>
            <div id="errorMessage" class="hidden text-center text-red-600 font-medium p-2 rounded-lg bg-red-50"></div>
            <div class="border-t border-gray-200 pt-6"><h3 class="text-lg font-semibold text-gray-800 mb-4 text-center">Riwayat Semua Transaksi</h3><div id="historyList" class="max-h-64 overflow-y-auto space-y-3 pr-2"><p id="noHistory" class="text-center text-gray-500">Belum ada transaksi.</p></div></div>
        </div>
        <div id="loading" class="flex flex-col items-center justify-center p-8"><div class="loader"></div><p class="text-gray-500 mt-4">Menghubungkan ke database online...</p></div>
    </div>

    <!-- Modal Konfirmasi -->
    <div id="confirmationModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8 w-full max-w-md space-y-4">
            <h3 class="text-xl font-bold text-gray-800 text-center">Konfirmasi Transaksi</h3>
            <div class="border-t border-b border-gray-200 py-4 space-y-2">
                <div class="flex justify-between"><span class="text-gray-500">Tipe:</span><strong id="confirmType" class="font-semibold text-gray-900"></strong></div>
                <div class="flex justify-between"><span class="text-gray-500">Sumber:</span><strong id="confirmSource" class="font-semibold text-gray-900"></strong></div>
                <div class="flex justify-between"><span class="text-gray-500">Jumlah:</span><strong id="confirmAmount" class="font-semibold text-gray-900"></strong></div>
                <div class="flex justify-between"><span class="text-gray-500">Keterangan:</span><strong id="confirmDescription" class="font-semibold text-gray-900 text-right truncate"></strong></div>
                <div class="flex justify-between"><span class="text-gray-500">Biaya Admin:</span><strong id="confirmAdminFee" class="font-semibold text-gray-900"></strong></div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <button id="cancelBtnModal" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-4 rounded-lg">Batal</button>
                <button id="confirmBtnModal" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg">Konfirmasi & Simpan</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- KONFIGURASI FIREBASE ANDA TELAH DIMASUKKAN DI SINI ---
        const firebaseConfig = {
          apiKey: "AIzaSyApmezbFi-ntkp_J8T-b7uk2NTZeFuzBrI",
          authDomain: "kasir-coba-e8862.firebaseapp.com",
          projectId: "kasir-coba-e8862",
          storageBucket: "kasir-coba-e8862.appspot.com",
          messagingSenderId: "529514154178",
          appId: "1:529514154178:web:339fed8dac7e37c367135b",
          measurementId: "G-736R59S3P3"
        };


        // --- SELEKSI ELEMEN DOM ---
        const totalDepositTodayEl=document.getElementById("totalDepositToday"),totalWithdrawalTodayEl=document.getElementById("totalWithdrawalToday"),totalAdminFeeTodayEl=document.getElementById("totalAdminFeeToday"),amountInput=document.getElementById("amount"),descriptionInput=document.getElementById("description"),adminFeeInput=document.getElementById("adminFee"),sourceSelect=document.getElementById("sourceSelect"),depositBtn=document.getElementById("depositBtn"),withdrawBtn=document.getElementById("withdrawBtn"),historyListEl=document.getElementById("historyList"),errorMessageEl=document.getElementById("errorMessage"),loadingEl=document.getElementById("loading"),mainContentEl=document.getElementById("main-content"),transactionForm=document.getElementById("transactionForm"),adminFeeToggle=document.getElementById("adminFeeToggle"),adminFeeWrapper=document.getElementById("adminFeeWrapper"),sourceWrapper=document.getElementById("sourceWrapper");
        const confirmationModal=document.getElementById("confirmationModal"),confirmType=document.getElementById("confirmType"),confirmSource=document.getElementById("confirmSource"),confirmAmount=document.getElementById("confirmAmount"),confirmDescription=document.getElementById("confirmDescription"),confirmAdminFee=document.getElementById("confirmAdminFee"),cancelBtnModal=document.getElementById("cancelBtnModal"),confirmBtnModal=document.getElementById("confirmBtnModal");

        let db, transactionsCollection, pendingTransaction = null, currentTransactionType = 'setor';

        function formatCurrency(e){return new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(e)}
        function isToday(e){if(!e)return!1;const t=e.toDate(),n=new Date;return t.getDate()===n.getDate()&&t.getMonth()===n.getMonth()&&t.getFullYear()===n.getFullYear()}
        function showError(e){errorMessageEl.textContent=e,errorMessageEl.classList.remove("hidden"),setTimeout(()=>{errorMessageEl.classList.add("hidden")},4e3)}
        
        function updateUI(e){let t=0,n=0,o=0;e.forEach(e=>{isToday(e.createdAt)&&("setor"===e.type?t+=e.amount:n+=e.amount,o+=e.adminFee)}),totalDepositTodayEl.textContent=formatCurrency(t),totalWithdrawalTodayEl.textContent=formatCurrency(n),totalAdminFeeTodayEl.textContent=formatCurrency(o),historyListEl.innerHTML="",0===e.length?historyListEl.innerHTML='<p class="text-center text-gray-500">Belum ada transaksi.</p>':e.forEach(e=>{const t=e.createdAt.toDate(),n=e.source?`<p class="text-sm text-gray-500">Sumber: <strong>${e.source}</strong></p>`:"",o=`\n                        <div class="flex justify-between items-start bg-gray-50 p-3 rounded-lg">\n                            <div class="flex-grow">\n                                <p class="font-semibold capitalize">${e.type} Tunai</p>\n                                <p class="text-sm italic text-gray-600">${e.description||""}</p>\n                                ${n}\n                                <p class="text-xs text-gray-500 mt-1">${t.toLocaleString("id-ID",{dateStyle:"full",timeStyle:"short"})}</p>\n                            </div>\n                            <div class="text-right flex-shrink-0 ml-4">\n                                <p class="font-semibold ${"setor"===e.type?"text-green-600":"text-red-600"}">${"setor"===e.type?"+":"-"} ${formatCurrency(e.amount)}</p>\n                                ${e.adminFee>0?`<p class="text-xs text-gray-400">Biaya Admin: ${formatCurrency(e.adminFee)}</p>`:""}\n                            </div>\n                        </div>`;historyListEl.insertAdjacentHTML("beforeend",o)})}
        
        function showConfirmation(e){
            pendingTransaction = e;
            const t=e.type.charAt(0).toUpperCase()+e.type.slice(1);
            confirmType.textContent=`${t} Tunai`,
            confirmSource.textContent=e.source,
            confirmAmount.textContent=formatCurrency(e.amount),
            confirmDescription.textContent=e.description,
            confirmAdminFee.textContent=formatCurrency(e.adminFee),
            confirmationModal.classList.remove("hidden")
        }

        async function saveTransaction(){
            if (!pendingTransaction) return;
            depositBtn.disabled = true; withdrawBtn.disabled = true; confirmBtnModal.disabled = true;
            confirmBtnModal.textContent = "Menyimpan...";
            try {
                await addDoc(transactionsCollection, pendingTransaction);
                transactionForm.reset();
                adminFeeWrapper.classList.add('hidden');
                setTransactionMode('setor');
                amountInput.focus();
            } catch (error) {
                console.error("Error: ", error); showError("Gagal menyimpan. Cek koneksi.");
            } finally {
                confirmationModal.classList.add('hidden');
                depositBtn.disabled = false; withdrawBtn.disabled = false; confirmBtnModal.disabled = false;
                confirmBtnModal.textContent = "Konfirmasi & Simpan";
                pendingTransaction = null;
            }
        }
        
        function prepareTransaction(e){
            const t=parseFloat(amountInput.value),n=descriptionInput.value.trim(),o=document.querySelector('input[name="useAdminFee"]:checked').value,a=sourceSelect.value;
            let r=0;
            if(isNaN(t)||t<=0)return void showError("Jumlah transaksi harus valid.");
            if(!n)return void showError("Keterangan wajib diisi.");
            if("iya"===o){const e=parseFloat(adminFeeInput.value);if(isNaN(e)||e<=0)return void showError('Jika "Iya", biaya admin wajib diisi dan lebih dari nol.');r=e}
            const i={type:e,amount:t,description:n,adminFee:r,source:a,createdAt:serverTimestamp()};
            showConfirmation(i)
        }

        function setTransactionMode(type) {
            currentTransactionType = type;
            const sourceLabel = sourceWrapper.querySelector('label');
            if (type === 'setor') {
                sourceLabel.textContent = "Sumber Setoran";
            } else {
                sourceLabel.textContent = "Sumber Tarik Tunai";
            }
        }
        
        async function initialize(){
            if(!firebaseConfig.apiKey){
                loadingEl.innerHTML = '<p class="text-red-500 font-semibold text-center">KONFIGURASI FIREBASE KOSONG.</p>';
                return;
            }
            try{
                const app=initializeApp(firebaseConfig);
                const auth=getAuth(app);
                db=getFirestore(app);
                await signInAnonymously(auth);
                transactionsCollection = collection(db, "transactions");
                const q=query(transactionsCollection,orderBy("createdAt","desc"));
                onSnapshot(q,(snapshot)=>{
                    const transactions=snapshot.docs.map(doc=>({id:doc.id,...doc.data()}));
                    updateUI(transactions);
                    loadingEl.classList.add('hidden');
                    mainContentEl.classList.remove('hidden');
                }, (error) => {
                     console.error("Firebase Error:", error);
                     loadingEl.innerHTML = `<p class="text-red-500 font-semibold text-center">Error: ${error.message}. Coba refresh.</p>`;
                });
                
                depositBtn.addEventListener("click",()=>{ setTransactionMode('setor'); prepareTransaction("setor") });
                withdrawBtn.addEventListener("click",()=>{ setTransactionMode('tarik'); prepareTransaction("tarik") });
                transactionForm.addEventListener("submit",(e)=>{ e.preventDefault(); prepareTransaction(currentTransactionType); });
                adminFeeToggle.addEventListener("change",(e)=>{e.target.value==="iya"?adminFeeWrapper.classList.remove("hidden"):adminFeeWrapper.classList.add("hidden")});
                
                cancelBtnModal.addEventListener("click",()=>confirmationModal.classList.add("hidden"));
                confirmBtnModal.addEventListener("click",saveTransaction);

            } catch (error) {
                console.error("Init Gagal:", error);
                loadingEl.innerHTML = '<p class="text-red-500 font-semibold">Gagal terhubung. Periksa konfigurasi Firebase Anda.</p>';
            }
        }
        initialize();
    </script>
</body>
</html>


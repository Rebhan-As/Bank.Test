<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Kasir Online -</title>
    <!-- Memuat Tailwind CSS untuk styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Memuat Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        #historyList::-webkit-scrollbar { width: 8px; }
        #historyList::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        #historyList::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        #historyList::-webkit-scrollbar-thumb:hover { background: #555; }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3b82f6;
            width: 40px;
            height: 40px;
            animation: spin 1.5s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Style untuk modal agar transisinya lebih halus */
        .modal { transition: opacity 0.25s ease; }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Kontainer Utama Aplikasi -->
    <div class="w-full max-w-2xl bg-white rounded-2xl shadow-xl p-6 md:p-8 space-y-6">
        
        <header class="text-center">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Rekap Kasir Harian Online</h1>
            <p class="text-gray-500 mt-1">Total di bawah ini akan ter-reset setiap hari.</p>
        </header>

        <div id="main-content" class="hidden">
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center pt-4">
                <div class="bg-green-100 text-green-800 rounded-xl p-4 shadow"><h2 class="text-sm font-medium text-green-600">TOTAL SETORAN HARI INI</h2><p id="totalDepositToday" class="text-2xl md:text-3xl font-bold tracking-tight mt-1">Rp 0,00</p></div>
                <div class="bg-red-100 text-red-800 rounded-xl p-4 shadow"><h2 class="text-sm font-medium text-red-600">TOTAL TARIKAN HARI INI</h2><p id="totalWithdrawalToday" class="text-2xl md:text-3xl font-bold tracking-tight mt-1">Rp 0,00</p></div>
                <div class="bg-blue-100 text-blue-800 rounded-xl p-4 shadow"><h2 class="text-sm font-medium text-blue-600">TOTAL ADMIN HARI INI</h2><p id="totalAdminFeeToday" class="text-2xl md:text-3xl font-bold tracking-tight mt-1">Rp 0,00</p></div>
            </div>

            <form id="transactionForm" class="border-t border-gray-200 pt-6 space-y-4">
                <div id="sourceWrapper"><label for="sourceSelect" class="block text-sm font-medium text-gray-700 mb-1">Sumber Transaksi</label><select id="sourceSelect" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 py-3 px-4 text-lg"><option>Uang Tunai</option><option>BRI</option><option>BCA</option><option>Seabank</option><option>Dana</option><option>Gopay</option><option>Digipos</option><option>Order Quota</option><option>Simpel</option></select></div>
                <div><label for="amount" class="block text-sm font-medium text-gray-700 mb-1">Jumlah Transaksi</label><div class="relative"><div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3"><span class="text-gray-500 sm:text-sm">Rp</span></div><input type="number" id="amount" class="block w-full rounded-md border-gray-300 pl-10 pr-4 py-3 text-lg focus:border-indigo-500 focus:ring-indigo-500" placeholder="0" required></div></div>
                <div><label for="description" class="block text-sm font-medium text-gray-700 mb-1">Keterangan (Wajib Diisi)</label><input type="text" id="description" class="block w-full rounded-md border-gray-300 px-4 py-3 text-lg focus:border-indigo-500 focus:ring-indigo-500" placeholder="Contoh: Tarik tunai Budi" required></div>
                <div><label class="block text-sm font-medium text-gray-700 mb-2">Gunakan Biaya Admin?</label><div id="adminFeeToggle" class="flex items-center space-x-4"><label class="flex items-center"><input type="radio" name="useAdminFee" value="tidak" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500" checked> <span class="ml-2 text-gray-700">Tidak</span></label><label class="flex items-center"><input type="radio" name="useAdminFee" value="iya" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500"> <span class="ml-2 text-gray-700">Iya</span></label></div></div>
                <div id="adminFeeWrapper" class="hidden"><label for="adminFee" class="block text-sm font-medium text-gray-700 mb-1">Jumlah Biaya Admin</label><div class="relative"><div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3"><span class="text-gray-500 sm:text-sm">Rp</span></div><input type="number" id="adminFee" class="block w-full rounded-md border-gray-300 pl-10 pr-4 py-3 text-lg focus:border-indigo-500 focus:ring-indigo-500" placeholder="0"></div></div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><button type="button" id="depositBtn" class="flex items-center justify-center w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105 shadow-md disabled:opacity-50 disabled:cursor-not-allowed">Setor Tunai</button><button type="button" id="withdrawBtn" class="flex items-center justify-center w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105 shadow-md disabled:opacity-50 disabled:cursor-not-allowed">Tarik Tunai</button></div>
            </form>
            <div id="errorMessage" class="hidden text-center text-red-600 font-medium p-2 rounded-lg bg-red-50"></div>
            
            <div class="border-t border-gray-200 pt-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">Riwayat Transaksi</h3>
                    <button id="exportBtn" class="flex items-center bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                        Export
                    </button>
                </div>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <div><label for="dateFilter" class="block text-xs font-medium text-gray-600">Filter Berdasarkan Tanggal</label><input type="date" id="dateFilter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 text-sm py-2 px-3"></div>
                    <div class="self-end"><button id="resetFilterBtn" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg text-sm">Tampilkan Semua</button></div>
                </div>

                <div id="historyList" class="max-h-64 overflow-y-auto space-y-3 pr-2"><p id="noHistory" class="text-center text-gray-500">Belum ada transaksi.</p></div>
            </div>
        </div>
        <div id="loading" class="flex flex-col items-center justify-center p-8"><div class="loader"></div><p class="text-gray-500 mt-4">Menghubungkan ke database online...</p></div>
    </div>

    <!-- Modal Konfirmasi Simpan -->
    <div id="confirmationModal" class="hidden modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8 w-full max-w-md space-y-4"><h3 class="text-xl font-bold text-gray-800 text-center">Konfirmasi Transaksi</h3><div class="border-t border-b border-gray-200 py-4 space-y-2"><div class="flex justify-between"><span class="text-gray-500">Tipe:</span><strong id="confirmType" class="font-semibold text-gray-900"></strong></div><div class="flex justify-between"><span class="text-gray-500">Sumber:</span><strong id="confirmSource" class="font-semibold text-gray-900"></strong></div><div class="flex justify-between"><span class="text-gray-500">Jumlah:</span><strong id="confirmAmount" class="font-semibold text-gray-900"></strong></div><div class="flex justify-between"><span class="text-gray-500">Keterangan:</span><strong id="confirmDescription" class="font-semibold text-gray-900 text-right truncate"></strong></div><div class="flex justify-between"><span class="text-gray-500">Biaya Admin:</span><strong id="confirmAdminFee" class="font-semibold text-gray-900"></strong></div></div><div class="grid grid-cols-2 gap-4"><button id="cancelBtnModal" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-4 rounded-lg">Batal</button><button id="confirmBtnModal" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg">Konfirmasi & Simpan</button></div></div>
    </div>
    
    <!-- Modal Edit (BARU) -->
    <div id="editModal" class="hidden modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8 w-full max-w-md space-y-4">
            <h3 class="text-xl font-bold text-gray-800 text-center">Edit Transaksi</h3>
            <form id="editForm" class="space-y-4">
                 <div><label for="editSourceSelect" class="block text-sm font-medium text-gray-700">Sumber</label><select id="editSourceSelect" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"><option>Uang Tunai</option><option>BRI</option><option>BCA</option><option>Seabank</option><option>Dana</option><option>Gopay</option><option>Digipos</option><option>Order Quota</option><option>Simpel</option></select></div>
                 <div><label for="editAmount" class="block text-sm font-medium text-gray-700">Jumlah</label><input type="number" id="editAmount" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required></div>
                 <div><label for="editDescription" class="block text-sm font-medium text-gray-700">Keterangan</label><input type="text" id="editDescription" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required></div>
                 <div><label for="editAdminFee" class="block text-sm font-medium text-gray-700">Biaya Admin</label><input type="number" id="editAdminFee" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required></div>
            </form>
            <div class="grid grid-cols-2 gap-4">
                <button id="cancelEditBtn" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-4 rounded-lg">Batal</button>
                <button id="saveEditBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg">Simpan Perubahan</button>
            </div>
        </div>
    </div>
    
    <!-- Modal Konfirmasi Hapus (BARU) -->
    <div id="deleteConfirmationModal" class="hidden modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8 w-full max-w-md space-y-4">
            <h3 class="text-xl font-bold text-red-600 text-center">Anda Yakin?</h3>
            <p class="text-center text-gray-600">Anda akan menghapus transaksi ini secara permanen. Aksi ini tidak bisa dibatalkan.</p>
            <div id="deleteDetail" class="text-sm text-center text-gray-500 border-t border-b py-2"></div>
            <div class="grid grid-cols-2 gap-4">
                <button id="cancelDeleteBtn" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-4 rounded-lg">Batal</button>
                <button id="confirmDeleteBtn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg">Hapus Permanen</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp, orderBy, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyApmezbFi-ntkp_J8T-b7uk2NTZeFuzBrI",
          authDomain: "kasir-coba-e8862.firebaseapp.com",
          projectId: "kasir-coba-e8862",
          storageBucket: "kasir-coba-e8862.appspot.com",
          messagingSenderId: "529514154178",
          appId: "1:529514154178:web:339fed8dac7e37c367135b",
          measurementId: "G-736R59S3P3"
        };
        
        const dom={totalDepositToday:document.getElementById("totalDepositToday"),totalWithdrawalToday:document.getElementById("totalWithdrawalToday"),totalAdminFeeToday:document.getElementById("totalAdminFeeToday"),amountInput:document.getElementById("amount"),descriptionInput:document.getElementById("description"),adminFeeInput:document.getElementById("adminFee"),sourceSelect:document.getElementById("sourceSelect"),depositBtn:document.getElementById("depositBtn"),withdrawBtn:document.getElementById("withdrawBtn"),historyList:document.getElementById("historyList"),errorMessage:document.getElementById("errorMessage"),loading:document.getElementById("loading"),mainContent:document.getElementById("main-content"),transactionForm:document.getElementById("transactionForm"),adminFeeToggle:document.getElementById("adminFeeToggle"),adminFeeWrapper:document.getElementById("adminFeeWrapper"),confirmationModal:document.getElementById("confirmationModal"),confirmType:document.getElementById("confirmType"),confirmSource:document.getElementById("confirmSource"),confirmAmount:document.getElementById("confirmAmount"),confirmDescription:document.getElementById("confirmDescription"),confirmAdminFee:document.getElementById("confirmAdminFee"),cancelBtnModal:document.getElementById("cancelBtnModal"),confirmBtnModal:document.getElementById("confirmBtnModal"),exportBtn:document.getElementById("exportBtn"),dateFilter:document.getElementById("dateFilter"),resetFilterBtn:document.getElementById("resetFilterBtn"),editModal:document.getElementById("editModal"),editForm:document.getElementById("editForm"),editSourceSelect:document.getElementById("editSourceSelect"),editAmount:document.getElementById("editAmount"),editDescription:document.getElementById("editDescription"),editAdminFee:document.getElementById("editAdminFee"),cancelEditBtn:document.getElementById("cancelEditBtn"),saveEditBtn:document.getElementById("saveEditBtn"),deleteConfirmationModal:document.getElementById("deleteConfirmationModal"),deleteDetail:document.getElementById("deleteDetail"),cancelDeleteBtn:document.getElementById("cancelDeleteBtn"),confirmDeleteBtn:document.getElementById("confirmDeleteBtn")};
        let db,transactionsCollection,pendingTransaction=null,currentTransactionType="setor",allTransactions=[],transactionToEdit=null,transactionToDelete=null;
        
        function formatCurrency(e){return new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(e)}
        function isToday(e){if(!e)return!1;const t=e.toDate(),n=new Date;return t.getDate()===n.getDate()&&t.getMonth()===n.getMonth()&&t.getFullYear()===n.getFullYear()}
        function showError(e){dom.errorMessage.textContent=e,dom.errorMessage.classList.remove("hidden"),setTimeout(()=>{dom.errorMessage.classList.add("hidden")},4e3)}
        
        function updateUI(e){
            allTransactions=e;const t=dom.dateFilter.value;let n=allTransactions;if(t){n=allTransactions.filter(e=>{if(!e.createdAt)return!1;return e.createdAt.toDate().toISOString().slice(0,10)===t})}let o=0,a=0,r=0;allTransactions.forEach(e=>{isToday(e.createdAt)&&("setor"===e.type?o+=e.amount:a+=e.amount,r+=e.adminFee)}),dom.totalDepositToday.textContent=formatCurrency(o),dom.totalWithdrawalToday.textContent=formatCurrency(a),dom.totalAdminFeeToday.textContent=formatCurrency(r),dom.historyList.innerHTML="",0===n.length?dom.historyList.innerHTML='<p class="text-center text-gray-500">Tidak ada transaksi untuk filter ini.</p>':n.forEach(e=>{const t=e.createdAt.toDate(),n=e.source?`<p class="text-sm text-gray-500">Sumber: <strong>${e.source}</strong></p>`:"",o=`\n                        <div class="flex justify-between items-start bg-gray-50 p-3 rounded-lg">\n                            <div class="flex-grow">\n                                <p class="font-semibold capitalize">${e.type} Tunai</p>\n                                <p class="text-sm italic text-gray-600">${e.description||""}</p>\n                                ${n}\n                                <p class="text-xs text-gray-500 mt-1">${t.toLocaleString("id-ID",{dateStyle:"full",timeStyle:"short"})}</p>\n                            </div>\n                            <div class="text-right flex-shrink-0 ml-4">\n                                <p class="font-semibold ${"setor"===e.type?"text-green-600":"text-red-600"}">${"setor"===e.type?"+":"-"} ${formatCurrency(e.amount)}</p>\n                                ${e.adminFee>0?`<p class="text-xs text-gray-400">Biaya Admin: ${formatCurrency(e.adminFee)}</p>`:""}\n                            </div>\n                             <div class="flex flex-col space-y-2 ml-4">\n                                <button class="edit-btn p-1 text-blue-500 hover:text-blue-700" data-id="${e.id}"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button>\n                                <button class="delete-btn p-1 text-red-500 hover:text-red-700" data-id="${e.id}"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button>\n                            </div>\n                        </div>`;dom.historyList.insertAdjacentHTML("beforeend",o)})}
        
        function showConfirmation(e){pendingTransaction=e;const t=e.type.charAt(0).toUpperCase()+e.type.slice(1);dom.confirmType.textContent=`${t} Tunai`,dom.confirmSource.textContent=e.source,dom.confirmAmount.textContent=formatCurrency(e.amount),dom.confirmDescription.textContent=e.description,dom.confirmAdminFee.textContent=formatCurrency(e.adminFee),dom.confirmationModal.classList.remove("hidden")}
        async function saveTransaction(){if(!pendingTransaction)return;dom.depositBtn.disabled=!0,dom.withdrawBtn.disabled=!0,dom.confirmBtnModal.disabled=!0,dom.confirmBtnModal.textContent="Menyimpan...";try{await addDoc(transactionsCollection,pendingTransaction),dom.transactionForm.reset(),dom.adminFeeWrapper.classList.add("hidden"),setTransactionMode("setor"),dom.amountInput.focus()}catch(e){console.error("Error: ",e),showError("Gagal menyimpan. Cek koneksi.")}finally{dom.confirmationModal.classList.add("hidden"),dom.depositBtn.disabled=!1,dom.withdrawBtn.disabled=!1,dom.confirmBtnModal.disabled=!1,dom.confirmBtnModal.textContent="Konfirmasi & Simpan",pendingTransaction=null}}
        function prepareTransaction(e){const t=parseFloat(dom.amountInput.value),n=dom.descriptionInput.value.trim(),o=document.querySelector('input[name="useAdminFee"]:checked').value,a=dom.sourceSelect.value;let r=0;if(isNaN(t)||t<=0)return void showError("Jumlah transaksi harus valid.");if(!n)return void showError("Keterangan wajib diisi.");if("iya"===o){const e=parseFloat(dom.adminFeeInput.value);if(isNaN(e)||e<=0)return void showError('Jika "Iya", biaya admin wajib diisi dan lebih dari nol.');r=e}const i={type:e,amount:t,description:n,adminFee:r,source:a,createdAt:serverTimestamp()};showConfirmation(i)}
        function setTransactionMode(e){currentTransactionType=e;const t=dom.transactionForm.querySelector("#sourceWrapper label");"setor"===e?t.textContent="Sumber Setoran":t.textContent="Sumber Tarik Tunai"}
        
        function openEditModal(e){transactionToEdit=e,dom.editSourceSelect.value=e.source,dom.editAmount.value=e.amount,dom.editDescription.value=e.description,dom.editAdminFee.value=e.adminFee,dom.editModal.classList.remove("hidden")}
        async function saveEdit(){if(!transactionToEdit)return;const e=parseFloat(dom.editAmount.value),t=dom.editDescription.value.trim(),n=parseFloat(dom.editAdminFee.value),o=dom.editSourceSelect.value;if(isNaN(e)||e<=0)return void showError("Jumlah pada form edit harus valid.");if(!t)return void showError("Keterangan pada form edit wajib diisi.");if(isNaN(n)||n<0)return void showError("Biaya admin pada form edit harus valid.");const a=doc(db,"transactions",transactionToEdit.id),r={amount:e,description:t,adminFee:n,source:o};try{await updateDoc(a,r),dom.editModal.classList.add("hidden"),transactionToEdit=null}catch(e){console.error("Error update:",e),showError("Gagal menyimpan perubahan.")}}
        
        function showDeleteConfirmation(e){transactionToDelete=e,dom.deleteDetail.textContent=`"${e.description}" (${formatCurrency(e.amount)})`,dom.deleteConfirmationModal.classList.remove("hidden")}
        async function deleteTransaction(){if(!transactionToDelete)return;const e=doc(db,"transactions",transactionToDelete.id);try{await deleteDoc(e),dom.deleteConfirmationModal.classList.add("hidden"),transactionToDelete=null}catch(e){console.error("Error delete:",e),showError("Gagal menghapus transaksi.")}}

        function exportToCSV() {
            const t=dom.dateFilter.value;let n=allTransactions;if(t){n=allTransactions.filter(e=>{if(!e.createdAt)return!1;return e.createdAt.toDate().toISOString().slice(0,10)===t})}
            if(n.length===0){return void showError("Tidak ada data untuk diexport pada filter ini.")}
            const o=["Tanggal","Waktu","Tipe","Sumber","Jumlah","Biaya Admin","Keterangan"],a=n.map(e=>{const t=e.createdAt.toDate(),n=t.toLocaleDateString("id-ID",{day:"2-digit",month:"2-digit",year:"numeric"}),o=t.toLocaleTimeString("id-ID",{hour:"2-digit",minute:"2-digit"}),a=`"${(e.description||"").replace(/"/g,'""')}"`;return[n,o,e.type,e.source||"",e.amount,e.adminFee,a].join(",")});
            const r=[o.join(","),...a].join("\n"),i=new Blob([r],{type:"text/csv;charset=utf-8;"}),s=document.createElement("a"),l=URL.createObjectURL(i);s.setAttribute("href",l);
            const c=t||(new Date).toISOString().slice(0,10);s.setAttribute("download",`Riwayat_Transaksi_${c}.csv`),s.style.visibility="hidden",document.body.appendChild(s),s.click(),document.body.removeChild(s)
        }
        
        async function initialize(){if(!firebaseConfig.apiKey)return void(dom.loading.innerHTML='<p class="text-red-500 font-semibold text-center">KONFIGURASI FIREBASE KOSONG.</p>');try{const e=initializeApp(firebaseConfig),t=getAuth(e);db=getFirestore(e),await signInAnonymously(t),transactionsCollection=collection(db,"transactions");const n=query(transactionsCollection,orderBy("createdAt","desc"));onSnapshot(n,e=>{const t=e.docs.map(e=>({id:e.id,...e.data()}));updateUI(t),dom.loading.classList.add("hidden"),dom.mainContent.classList.remove("hidden")}),dom.depositBtn.addEventListener("click",()=>{setTransactionMode("setor"),prepareTransaction("setor")}),dom.withdrawBtn.addEventListener("click",()=>{setTransactionMode("tarik"),prepareTransaction("tarik")}),dom.transactionForm.addEventListener("submit",e=>{e.preventDefault(),prepareTransaction(currentTransactionType)}),dom.adminFeeToggle.addEventListener("change",e=>{e.target.value==="iya"?dom.adminFeeWrapper.classList.remove("hidden"):dom.adminFeeWrapper.classList.add("hidden")}),dom.cancelBtnModal.addEventListener("click",()=>dom.confirmationModal.classList.add("hidden")),dom.confirmBtnModal.addEventListener("click",saveTransaction),dom.exportBtn.addEventListener("click",exportToCSV),dom.dateFilter.addEventListener("change",()=>updateUI(allTransactions)),dom.resetFilterBtn.addEventListener("click",()=>{dom.dateFilter.value="",updateUI(allTransactions)});
            dom.historyList.addEventListener("click",e=>{const t=e.target.closest(".edit-btn"),n=e.target.closest(".delete-btn");if(t){const o=t.dataset.id,a=allTransactions.find(e=>e.id===o);a&&openEditModal(a)}if(n){const o=n.dataset.id,a=allTransactions.find(e=>e.id===o);a&&showDeleteConfirmation(a)}});
            dom.cancelEditBtn.addEventListener("click",()=>dom.editModal.classList.add("hidden"));dom.saveEditBtn.addEventListener("click",saveEdit);dom.cancelDeleteBtn.addEventListener("click",()=>dom.deleteConfirmationModal.classList.add("hidden"));dom.confirmDeleteBtn.addEventListener("click",deleteTransaction)}catch(e){console.error("Init Gagal:",e),dom.loading.innerHTML='<p class="text-red-500 font-semibold">Gagal terhubung. Periksa konfigurasi Firebase Anda.</p>'}}
        initialize();
    </script>
</body>
</html>
